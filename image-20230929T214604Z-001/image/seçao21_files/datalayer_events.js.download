window.dataLayer=window.dataLayer||[];(function($,Drupal,drupalSettings){Drupal.behaviors.attachDatalayerEvents={locationChanged:false,attach:function(context,settings){if(settings.AlzDatalayer){jQuery.each(settings.AlzDatalayer,function(i,v){window.dataLayer.push(v);});settings.AlzDatalayer=undefined;}
$('[data-alz-related-content]',context).once('DatalayerEvents').each(function(i,form){$('[data-alz-related-content-role="submit"]',form).on('click',function(){var data={'event':'virtualPageview','vpv':'/vpv/submit/personalisation'};$('[data-alz-related-content-category-selected="1"]',form).each(function(i){data['option'+(i+1)]=$(this).text();});window.dataLayer.push(data);});$(this).on('click',function(e){var article=$(e.target).parents('[data-content-type="article"]');if(article.length){window.dataLayer.push({event:'Related Content',relatedContentCategory:article.find('[data-content-type="content-label"]').text().trim(),relatedContentTitle:article.find('[data-content-type="title"]').text().trim(),});}});});var service_finder_current_step=undefined;$('#service-finder--form--steps',context).once('DatalayerEvents').each(function(){if(settings.serviceFinder){if(service_finder_current_step!==settings.serviceFinder.current_step){service_finder_current_step=settings.serviceFinder.current_step;var step_name=settings.serviceFinder.steps[settings.serviceFinder.current_step];window.dataLayer.push({'event':'virtualPageview','stepName':step_name,'vpv':'/vpv/'+step_name});}}})
$('#views-exposed-form-taxonomy-term-page-1 input[type="submit"]',context).on('click',function(){window.dataLayer.push({'event':'filteredContent','eventCategory':'Content Filter','eventLabel':window.location.pathname,'eventAction':extractOptionsValues(this,'topics[]'),});});$('.alz-content-hub-filters[data-content-hub-type="events"] input[type="submit"]',context).on('mousedown',function(){window.dataLayer.push({'event':'filteredSearch','eventCategory':'Search Filter','eventAction':extractOptionsValues(this,'event_tag[]'),'eventLabel':extractOptionsValues(this,'location[]')+'|'+extractOptionsValues(this,'dates'),});});$('.alz-content-hub-filters[data-content-hub-type="mixed_content"] input[data-drupal-selector="edit-apply"]',context).on('mousedown',function(){window.dataLayer.push({'event':'filteredGeneral','eventCategory':'General Filter','eventAction':extractOptionsValues(this,'sitewide_terms[]'),'eventLabel':window.location.pathname});});$('.pattern--widget a',context).on('click',function(e){fireLocationChangingEvent(e,{'event':'inlineLinkWidget','eventCategory':'Inline Link Widget','eventAction':e.target.innerText,'eventLabel':e.currentTarget.href?e.currentTarget.pathname:'',});});$('.field--alz-more-like-me a',context).on('click',function(e){fireLocationChangingEvent(e,{'event':'articleLink','eventCategory':'Article Link','eventAction':e.target.innerText,'eventLabel':e.target.pathname,});});$('body').once('alz-track-comments-count').each(function(){window.dataLayer.push({'numberOfComments':$('.pattern--comment').length});});$('#menu--main a.menu--sub-section--link-item',context).on('click',function(e){fireLocationChangingEvent(e,{'event':'megaMenu','eventCategory':'Main Navigation','eventAction':$(this).parents('.menu--level--first--item').children('a').text().trim(),'eventLabel':e.target.innerText});});$('[data-alz-donation-form-id]',context).on('click','[type=submit]',function(e){const $form=$(e.target).parents('[data-alz-donation-form-id]');const widgetType=$form.attr("data-donation-widget-type");const monthlyDonation=$form.find("[name='donation_type'][value='regular']:checked, [name='is_regular']:checked").length>0;const donationType=monthlyDonation?'monthly':'single';const $donationAmountCampaignSingle=$form.find("[name='donation_single[amount]']:checked")||false;const $donationAmountCampaignMonthly=$form.find("[name='donation_regular[amount]']:checked")||false;const $donationAmountContextual=$form.find("[name='amount']:checked")||false;let donationAmount=$form.find("[name='custom_amount']").val()||0;if($donationAmountCampaignSingle.length||$donationAmountCampaignMonthly.length){donationAmount=donationType==='monthly'?$donationAmountCampaignMonthly.val():$donationAmountCampaignSingle.val();}
if($donationAmountContextual.length){donationAmount=$donationAmountContextual.val();}
if(donationAmount){fireLocationChangingEvent(e,{'event':'donationWidget','eventCategory':'Donation Widget','eventAction':`${widgetType} form`,'eventLabel':donationType,'eventValue':donationAmount});}});function extractOptionsValues(relativeElement,targetElementName){return $(relativeElement).parents('form').find('select[name="'+targetElementName+'"] option:selected').filter(function(i,elm){return elm.value.length>0;}).map(function(i,option){return option.innerText;}).toArray().join(',')||'any';}
function fireLocationChangingEvent(domEvent,trackingEvent){var location=domEvent.currentTarget.href;if(location!==undefined){domEvent.preventDefault();locationChangingEventFallback(trackingEvent,location);}
window.dataLayer.push(trackingEvent);}
function locationChangingEventFallback(event,location){event.eventCallback=function(){document.location=location;Drupal.behaviors.attachDatalayerEvents.locationChanged=true;}
setTimeout(function(){if(!Drupal.behaviors.attachDatalayerEvents.locationChanged){document.location=location;}},300);}
function filterString(str){str=str.normalize("NFD").replace(/[\u0300-\u036f]/g,"");str=str.replace(/[!?\u00A1\u00BF]/g,"");str=str.trim();str=str.toLowerCase();return str;}
const dataArray=drupalSettings.alz_gtm_datalayer;function sendInteractionDataLayer(elemCategory,elemName,elemLabel){elemCategory=filterString(elemCategory);elemName=filterString(elemName);elemLabel=filterString(elemLabel);dataLayer.push({'event':'interaction','interaction':{'eventCategory':elemCategory,'eventName':elemName,'eventLabel':elemLabel},dataArray});}
$('[data-alz-donation-form-id]',context).on('click','[type=submit]',function(e){const widgetName=$(this).attr('value');sendInteractionDataLayer('Campaign donation widget','clickInput',widgetName);});const externalLinks=$('a[href^="http"], a[href^="https"]').not('[href*="'+window.location.hostname+'"]',context);externalLinks.once('externalLinkDataLayer').click(function(event){const $parent=$(this).closest('#menu--social');if($parent.length>0){sendInteractionDataLayer('externalLink','clickLink',$(this).find('span').text());}else{sendInteractionDataLayer('externalLink','clickLink',$(this).text());}});const linksAndButtons=$('a, button',context);linksAndButtons.once('linkAndButtonDataLayer').click(function(event){const $this=$(this);const elementType=$this.is('button')?'clickButton':'clickLink';const elementText=$this.text();if($this.closest('.contextual-links-donation-widget__links-primary').length){sendInteractionDataLayer('Campaign donation widget','clickLink',elementText);}
if($this.hasClass('contextual-form-donation-widget__submit')){sendInteractionDataLayer('Campaign donation widget','clickButton',elementText);}
if($this.hasClass('button')){sendInteractionDataLayer('allClicksButtonOrLink',elementType,elementText);}
if($this.closest('#navigation--main').length){sendInteractionDataLayer('Main Navigation',elementType,elementText);}
if(($this.hasClass('banner-navigation--link'))||($this.closest('.banner-holder').length)){const elementTextBanner=$this.find('.pattern--button').text();sendInteractionDataLayer('bannerClick',elementType,elementTextBanner);}
if(elementType==='clickLink'){let isDownload=false;let fileExtensions=['.pdf','.doc','.docx','.xls','.xlsx','.zip','.rar'];let elementUrl=$this.attr('href');if(elementUrl){for(let i=0;i<fileExtensions.length;i++){if(elementUrl.toLowerCase().endsWith(fileExtensions[i])){isDownload=true;break;}}}
if(isDownload){sendInteractionDataLayer('Download',elementType,elementText);}}});},};})(jQuery,Drupal,drupalSettings);